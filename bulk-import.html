<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bulk Import Manager - Inventory System</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    
    <!-- SheetJS for Excel parsing -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Public+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #141824;
            --bg-tertiary: #1e2433;
            --accent-primary: #00ff87;
            --accent-secondary: #00d4ff;
            --accent-warning: #ffd700;
            --accent-danger: #ff4757;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0ab;
            --border: #2d3548;
        }

        body {
            font-family: 'Public Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .background-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 135, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 135, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
        }

        .card {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .upload-area {
            border: 3px dashed var(--border);
            border-radius: 12px;
            padding: 60px 40px;
            text-align: center;
            background: var(--bg-tertiary);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .upload-area:hover, .upload-area.drag-over {
            border-color: var(--accent-primary);
            background: rgba(0, 255, 135, 0.05);
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .upload-hint {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Public Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            margin-right: 10px;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 135, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            margin-bottom: 8px;
        }

        .stat-value.valid { color: var(--accent-primary); }
        .stat-value.warning { color: var(--accent-warning); }
        .stat-value.error { color: var(--accent-danger); }

        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table-container {
            overflow-x: auto;
            background: var(--bg-tertiary);
            border-radius: 8px;
            margin-bottom: 24px;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px;
        }

        .data-table th {
            background: var(--bg-primary);
            color: var(--accent-primary);
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
            white-space: nowrap;
        }

        .data-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border);
            position: relative;
        }

        .data-table tr:hover {
            background: rgba(0, 255, 135, 0.05);
        }

        .data-table input {
            width: 100%;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .data-table input:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .data-table input.error {
            border-color: var(--accent-danger);
            background: rgba(255, 71, 87, 0.1);
        }

        .data-table input.warning {
            border-color: var(--accent-warning);
            background: rgba(255, 215, 0, 0.1);
        }

        .data-table input.valid {
            border-color: var(--accent-primary);
        }

        .field-status {
            position: absolute;
            right: 4px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 14px;
        }

        .autocomplete-dropdown {
            position: absolute;
            background: var(--bg-primary);
            border: 2px solid var(--accent-primary);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0, 255, 135, 0.2);
        }

        .autocomplete-item {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
        }

        .autocomplete-item:hover {
            background: var(--accent-primary);
            color: var(--bg-primary);
        }

        .autocomplete-item:last-child {
            border-bottom: none;
        }

        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid;
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .alert-success {
            background: rgba(0, 255, 135, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .alert-warning {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .alert-error {
            background: rgba(255, 71, 87, 0.1);
            border-color: var(--accent-danger);
            color: var(--accent-danger);
        }

        .error-list {
            margin-top: 12px;
            padding-left: 20px;
        }

        .error-list li {
            margin-bottom: 4px;
            font-size: 13px;
        }

        .row-number {
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-weight: 600;
            text-align: center;
        }

        .row-error {
            background: rgba(255, 71, 87, 0.1);
        }

        .row-warning {
            background: rgba(255, 215, 0, 0.05);
        }

        .progress-bar {
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 12px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            transition: width 0.3s ease;
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .button-group {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        .hidden {
            display: none;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .table-container {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="background-grid"></div>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBS-a3pzozzUEBeFlVQzPs4cD6uNDPzN2c",
            authDomain: "midstateinventory-43f99.firebaseapp.com",
            projectId: "midstateinventory-43f99",
            storageBucket: "midstateinventory-43f99.firebasestorage.app",
            messagingSenderId: "20000371750",
            appId: "1:20000371750:web:e255b4b72661c27c2b62e7",
            measurementId: "G-814FR7GR7T"
        };

        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // Field definitions
        const FIELDS = [
            { key: 'serial', label: 'Serial Number', required: true, type: 'text' },
            { key: 'name', label: 'Item Name', required: true, type: 'text' },
            { key: 'brand', label: 'Brand', required: false, type: 'autocomplete' },
            { key: 'model', label: 'Model Number', required: false, type: 'text' },
            { key: 'style', label: 'Style', required: false, type: 'text' },
            { key: 'department', label: 'Department', required: false, type: 'autocomplete' },
            { key: 'location', label: 'Location', required: true, type: 'autocomplete' },
            { key: 'binLocation', label: 'Bin Location', required: true, type: 'text' },
            { key: 'productDescription', label: 'Product Description', required: true, type: 'text' },
            { key: 'quantity', label: 'Quantity', required: false, type: 'number' },
            { key: 'price', label: 'Unit Price', required: false, type: 'number' },
            { key: 'reorderPoint', label: 'Reorder Point', required: false, type: 'number' },
            { key: 'hasMissingParts', label: 'Has Missing Parts', required: false, type: 'select' },
            { key: 'missingPartsNotes', label: 'Missing Parts Notes', required: false, type: 'text' }
        ];

        // Main Component
        function BulkImportManager() {
            const [user, setUser] = useState(null);
            const [isAuthenticated, setIsAuthenticated] = useState(false);
            const [loading, setLoading] = useState(true);
            const [data, setData] = useState([]);
            const [errors, setErrors] = useState({});
            const [warnings, setWarnings] = useState({});
            const [recommendations, setRecommendations] = useState({});
            const [importing, setImporting] = useState(false);
            const [progress, setProgress] = useState(0);
            const [message, setMessage] = useState(null);
            const fileInputRef = useRef(null);

            useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged((user) => {
                    setUser(user);
                    setIsAuthenticated(!!user);
                    setLoading(false);
                });
                return () => unsubscribe();
            }, []);

            useEffect(() => {
                if (user) {
                    loadRecommendations();
                }
            }, [user]);

            const loadRecommendations = async () => {
                try {
                    // Load existing inventory to build recommendations
                    const snapshot = await db.collection('inventory').get();
                    const recs = {
                        brands: new Set(),
                        departments: new Set(),
                        locations: new Set()
                    };

                    snapshot.docs.forEach(doc => {
                        const item = doc.data();
                        if (item.brand) recs.brands.add(item.brand);
                        if (item.department) recs.departments.add(item.department);
                        if (item.location) recs.locations.add(item.location);
                    });

                    setRecommendations({
                        brands: Array.from(recs.brands).sort(),
                        departments: Array.from(recs.departments).sort(),
                        locations: Array.from(recs.locations).sort()
                    });
                } catch (error) {
                    console.error('Error loading recommendations:', error);
                }
            };

            const handleLogout = async () => {
                if (window.confirm('Are you sure you want to logout?')) {
                    try {
                        await auth.signOut();
                    } catch (error) {
                        console.error('Logout error:', error);
                        alert('Error logging out. Please try again.');
                    }
                }
            };

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                
                if (file.name.endsWith('.csv')) {
                    reader.onload = (e) => {
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            complete: (results) => {
                                processData(results.data);
                            }
                        });
                    };
                    reader.readAsText(file);
                } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.onload = (e) => {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
                        processData(jsonData);
                    };
                    reader.readAsArrayBuffer(file);
                }
            };

            const processData = (rawData) => {
                const mapped = rawData.map((row, index) => ({
                    id: index,
                    serial: row['Serial Number'] || row.serial || '',
                    name: row['Item Name'] || row.name || '',
                    brand: row['Brand'] || row.brand || '',
                    model: row['Model Number'] || row.model || '',
                    style: row['Style'] || row.style || '',
                    department: row['Department'] || row.department || '',
                    location: row['Location'] || row.location || '',
                    binLocation: row['Bin Location'] || row.binLocation || '',
                    productDescription: row['Product Description'] || row.productDescription || '',
                    quantity: row['Quantity'] || row.quantity || '0',
                    price: row['Unit Price'] || row.price || '0',
                    reorderPoint: row['Reorder Point'] || row.reorderPoint || '10',
                    hasMissingParts: row['Has Missing Parts'] || row.hasMissingParts || 'No',
                    missingPartsNotes: row['Missing Parts Notes'] || row.missingPartsNotes || ''
                }));

                setData(mapped);
                validateAll(mapped);
                setMessage({ type: 'success', text: `‚úì Loaded ${mapped.length} rows successfully!` });
            };

            const validateAll = (items) => {
                const newErrors = {};
                const newWarnings = {};

                items.forEach((item, index) => {
                    const rowErrors = [];
                    const rowWarnings = [];

                    // Required fields
                    if (!item.serial) rowErrors.push('serial');
                    if (!item.name) rowErrors.push('name');
                    if (!item.location) rowErrors.push('location');
                    if (!item.binLocation) rowErrors.push('binLocation');
                    if (!item.productDescription) rowErrors.push('productDescription');

                    // Warnings for recommended fields
                    if (!item.brand) rowWarnings.push('brand');
                    if (!item.department) rowWarnings.push('department');
                    if (!item.quantity || item.quantity === '0') rowWarnings.push('quantity');

                    // Validate numbers
                    if (item.quantity && isNaN(item.quantity)) rowErrors.push('quantity');
                    if (item.price && isNaN(item.price)) rowErrors.push('price');
                    if (item.reorderPoint && isNaN(item.reorderPoint)) rowErrors.push('reorderPoint');

                    // Validate missing parts
                    if (item.hasMissingParts && !['Yes', 'No'].includes(item.hasMissingParts)) {
                        rowErrors.push('hasMissingParts');
                    }

                    if (rowErrors.length > 0) newErrors[index] = rowErrors;
                    if (rowWarnings.length > 0) newWarnings[index] = rowWarnings;
                });

                setErrors(newErrors);
                setWarnings(newWarnings);
            };

            const updateCell = (rowIndex, field, value) => {
                const newData = [...data];
                newData[rowIndex][field] = value;
                setData(newData);
                validateAll(newData);
            };

            const handleImport = async () => {
                const errorCount = Object.keys(errors).length;
                if (errorCount > 0) {
                    setMessage({ 
                        type: 'error', 
                        text: `Cannot import: ${errorCount} rows have errors. Please fix all required fields first.` 
                    });
                    return;
                }

                if (!window.confirm(`Import ${data.length} items into inventory?`)) {
                    return;
                }

                setImporting(true);
                setProgress(0);

                try {
                    let imported = 0;
                    let failed = 0;

                    for (let i = 0; i < data.length; i++) {
                        try {
                            const item = data[i];
                            await db.collection('inventory').add({
                                serial: item.serial,
                                name: item.name,
                                brand: item.brand || '',
                                model: item.model || '',
                                style: item.style || '',
                                department: item.department || '',
                                location: item.location,
                                binLocation: item.binLocation,
                                productDescription: item.productDescription,
                                quantity: parseInt(item.quantity) || 0,
                                price: parseFloat(item.price) || 0,
                                reorderPoint: parseInt(item.reorderPoint) || 10,
                                hasMissingParts: item.hasMissingParts === 'Yes',
                                missingPartsNotes: item.missingPartsNotes || '',
                                pickedBy: user.displayName || user.email,
                                pickedByUid: user.uid,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                                scannerType: 'bulk-import',
                                mode: 'imported'
                            });
                            imported++;
                        } catch (error) {
                            console.error(`Error importing row ${i}:`, error);
                            failed++;
                        }

                        setProgress(((i + 1) / data.length) * 100);
                    }

                    setImporting(false);
                    setMessage({ 
                        type: 'success', 
                        text: `‚úì Successfully imported ${imported} items!${failed > 0 ? ` ${failed} failed.` : ''}` 
                    });

                    // Clear data after successful import
                    setTimeout(() => {
                        setData([]);
                        setErrors({});
                        setWarnings({});
                    }, 2000);

                } catch (error) {
                    console.error('Import error:', error);
                    setImporting(false);
                    setMessage({ type: 'error', text: 'Import failed: ' + error.message });
                }
            };

            const downloadTemplate = () => {
                const headers = FIELDS.map(f => f.label).join(',');
                const example = 'ITEM-0001,Red Widget,Acme Corp,WDG-100,Large/Red,Manufacturing,Warehouse A,Aisle 3 Shelf B Bin 12,High-quality industrial widget,50,12.50,10,No,';
                const csv = headers + '\n' + example;
                
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'bulk-inventory-template.csv';
                a.click();
                URL.revokeObjectURL(url);
            };

            if (loading) {
                return (
                    <div className="app-container">
                        <div className="spinner"></div>
                    </div>
                );
            }

            if (!isAuthenticated) {
                return (
                    <div className="app-container">
                        <div className="container" style={{maxWidth: '600px', margin: '100px auto'}}>
                            <div className="alert alert-info">
                                <strong>‚ö†Ô∏è Login Required</strong><br/>
                                Please log in through your inventory system first, then access this tool.
                            </div>
                        </div>
                    </div>
                );
            }

            const validRows = data.length - Object.keys(errors).length;
            const warningRows = Object.keys(warnings).length;
            const errorRows = Object.keys(errors).length;

            return (
                <div className="app-container">
                    <div className="container">
                        <div className="header">
                            <h1>üìä Bulk Import Manager</h1>
                            <p>Upload, validate, and import inventory data</p>
                        </div>

                        <div className="card">
                            <div className="card-title">Upload File</div>
                            
                            <input 
                                ref={fileInputRef}
                                type="file" 
                                accept=".csv,.xlsx,.xls" 
                                onChange={handleFileUpload}
                                style={{display: 'none'}}
                            />
                            
                            <div 
                                className="upload-area"
                                onClick={() => fileInputRef.current.click()}
                            >
                                <div className="upload-icon">üìÅ</div>
                                <div className="upload-text">Click to upload or drag & drop</div>
                                <div className="upload-hint">Supports CSV, Excel (.xlsx, .xls)</div>
                            </div>

                            <div style={{marginTop: '20px', textAlign: 'center'}}>
                                <button className="btn btn-secondary" onClick={downloadTemplate}>
                                    ‚¨áÔ∏è Download Template
                                </button>
                            </div>
                        </div>

                        {message && (
                            <div className={`alert alert-${message.type}`}>
                                {message.text}
                            </div>
                        )}

                        {data.length > 0 && (
                            <>
                                <div className="stats-grid">
                                    <div className="stat-card">
                                        <div className="stat-value">{data.length}</div>
                                        <div className="stat-label">Total Rows</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value valid">{validRows}</div>
                                        <div className="stat-label">Valid</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value warning">{warningRows}</div>
                                        <div className="stat-label">Warnings</div>
                                    </div>
                                    <div className="stat-card">
                                        <div className="stat-value error">{errorRows}</div>
                                        <div className="stat-label">Errors</div>
                                    </div>
                                </div>

                                {errorRows > 0 && (
                                    <div className="alert alert-error">
                                        <strong>‚ö†Ô∏è Fix Required Fields</strong>
                                        <div className="error-list">
                                            <li>Required fields are marked with red borders</li>
                                            <li>Fill in all required fields to enable import</li>
                                            <li>{errorRows} row(s) need attention</li>
                                        </div>
                                    </div>
                                )}

                                {warningRows > 0 && errorRows === 0 && (
                                    <div className="alert alert-warning">
                                        <strong>‚ö†Ô∏è Optional Fields</strong>
                                        <div className="error-list">
                                            <li>Yellow fields are recommended but not required</li>
                                            <li>You can import now or fill these in later</li>
                                        </div>
                                    </div>
                                )}

                                <div className="card">
                                    <div className="card-title">Data Preview & Edit</div>
                                    
                                    <div className="table-container">
                                        <DataTable 
                                            data={data}
                                            errors={errors}
                                            warnings={warnings}
                                            recommendations={recommendations}
                                            onUpdateCell={updateCell}
                                        />
                                    </div>

                                    <div className="button-group">
                                        <button 
                                            className="btn btn-primary" 
                                            onClick={handleImport}
                                            disabled={errorRows > 0 || importing}
                                        >
                                            {importing ? '‚è≥ Importing...' : `‚úÖ Import ${data.length} Items`}
                                        </button>
                                        <button 
                                            className="btn btn-secondary" 
                                            onClick={() => {
                                                setData([]);
                                                setErrors({});
                                                setWarnings({});
                                                setMessage(null);
                                            }}
                                        >
                                            üóëÔ∏è Clear All
                                        </button>
                                        <button 
                                            className="btn btn-secondary" 
                                            onClick={() => window.open('/', '_blank')}
                                        >
                                            üì¶ Back to Inventory
                                        </button>
                                        <button 
                                            className="btn btn-secondary" 
                                            onClick={handleLogout}
                                            style={{background: 'var(--accent-danger)', borderColor: 'var(--accent-danger)'}}
                                        >
                                            üö™ Logout
                                        </button>
                                    </div>

                                    {importing && (
                                        <div className="progress-bar">
                                            <div className="progress-fill" style={{width: `${progress}%`}}></div>
                                        </div>
                                    )}
                                </div>
                            </>
                        )}
                    </div>
                </div>
            );
        }

        // DataTable Component
        function DataTable({ data, errors, warnings, recommendations, onUpdateCell }) {
            const [autocompleteVisible, setAutocompleteVisible] = useState(null);

            const getCellClass = (rowIndex, fieldKey) => {
                if (errors[rowIndex]?.includes(fieldKey)) return 'error';
                if (warnings[rowIndex]?.includes(fieldKey)) return 'warning';
                return '';
            };

            const getRecommendations = (fieldKey, value) => {
                if (!value) return [];
                const key = fieldKey === 'brand' ? 'brands' : 
                           fieldKey === 'department' ? 'departments' : 
                           fieldKey === 'location' ? 'locations' : null;
                
                if (!key || !recommendations[key]) return [];
                
                return recommendations[key].filter(item => 
                    item.toLowerCase().includes(value.toLowerCase())
                ).slice(0, 5);
            };

            return (
                <table className="data-table">
                    <thead>
                        <tr>
                            <th style={{width: '50px'}}>#</th>
                            {FIELDS.map(field => (
                                <th key={field.key}>
                                    {field.label} {field.required && <span style={{color: 'var(--accent-danger)'}}>*</span>}
                                </th>
                            ))}
                        </tr>
                    </thead>
                    <tbody>
                        {data.map((row, rowIndex) => (
                            <tr key={row.id} className={errors[rowIndex] ? 'row-error' : warnings[rowIndex] ? 'row-warning' : ''}>
                                <td className="row-number">{rowIndex + 1}</td>
                                {FIELDS.map(field => (
                                    <td key={field.key} style={{position: 'relative', minWidth: '150px'}}>
                                        {field.type === 'select' ? (
                                            <select 
                                                value={row[field.key]}
                                                onChange={(e) => onUpdateCell(rowIndex, field.key, e.target.value)}
                                                className={getCellClass(rowIndex, field.key)}
                                                style={{width: '100%', padding: '6px', background: 'var(--bg-primary)', color: 'var(--text-primary)', border: '1px solid var(--border)'}}
                                            >
                                                <option value="">Select...</option>
                                                <option value="Yes">Yes</option>
                                                <option value="No">No</option>
                                            </select>
                                        ) : (
                                            <div style={{position: 'relative'}}>
                                                <input
                                                    type={field.type === 'number' ? 'number' : 'text'}
                                                    value={row[field.key]}
                                                    onChange={(e) => onUpdateCell(rowIndex, field.key, e.target.value)}
                                                    className={getCellClass(rowIndex, field.key)}
                                                    placeholder={field.required ? 'Required' : 'Optional'}
                                                    onFocus={(e) => {
                                                        if (field.type === 'autocomplete') {
                                                            setAutocompleteVisible(`${rowIndex}-${field.key}`);
                                                        }
                                                    }}
                                                    onBlur={() => setTimeout(() => setAutocompleteVisible(null), 200)}
                                                />
                                                {field.type === 'autocomplete' && autocompleteVisible === `${rowIndex}-${field.key}` && (
                                                    <AutocompleteDropdown 
                                                        items={getRecommendations(field.key, row[field.key])}
                                                        onSelect={(value) => {
                                                            onUpdateCell(rowIndex, field.key, value);
                                                            setAutocompleteVisible(null);
                                                        }}
                                                    />
                                                )}
                                            </div>
                                        )}
                                        {errors[rowIndex]?.includes(field.key) && (
                                            <span className="field-status" style={{color: 'var(--accent-danger)'}}>‚ùå</span>
                                        )}
                                        {!errors[rowIndex]?.includes(field.key) && warnings[rowIndex]?.includes(field.key) && (
                                            <span className="field-status" style={{color: 'var(--accent-warning)'}}>‚ö†Ô∏è</span>
                                        )}
                                    </td>
                                ))}
                            </tr>
                        ))}
                    </tbody>
                </table>
            );
        }

        // Autocomplete Dropdown Component
        function AutocompleteDropdown({ items, onSelect }) {
            if (items.length === 0) return null;

            return (
                <div className="autocomplete-dropdown">
                    {items.map((item, index) => (
                        <div 
                            key={index}
                            className="autocomplete-item"
                            onMouseDown={() => onSelect(item)}
                        >
                            {item}
                        </div>
                    ))}
                </div>
            );
        }

        // Render
        ReactDOM.render(<BulkImportManager />, document.getElementById('root'));
    </script>
</body>
</html>
