<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integrated Label Maker - Firebase Connected</title>
    
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    
    <!-- JsBarcode Library -->
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Public+Sans:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-primary: #0a0e17;
            --bg-secondary: #141824;
            --bg-tertiary: #1e2433;
            --accent-primary: #00ff87;
            --accent-secondary: #00d4ff;
            --accent-warning: #ffd700;
            --accent-danger: #ff4757;
            --text-primary: #e8eaed;
            --text-secondary: #9aa0ab;
            --border: #2d3548;
        }

        body {
            font-family: 'Public Sans', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .background-grid {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 135, 0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 135, 0.03) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none;
            z-index: 0;
        }

        .app-container {
            position: relative;
            z-index: 1;
            min-height: 100vh;
            padding: 40px 20px;
        }

        .screen-only {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 36px;
            font-weight: 700;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
        }

        .main-content {
            display: grid;
            grid-template-columns: 420px 1fr;
            gap: 30px;
            margin-bottom: 40px;
        }

        .sidebar {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            height: fit-content;
            position: sticky;
            top: 20px;
        }

        .card {
            background: var(--bg-tertiary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent-primary);
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--border);
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            margin-bottom: 6px;
            color: var(--text-secondary);
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .required::after {
            content: " *";
            color: var(--accent-danger);
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            font-family: 'Public Sans', sans-serif;
            transition: all 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 255, 135, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: 'Public Sans', sans-serif;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn-primary {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            color: var(--bg-primary);
            margin-bottom: 10px;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 255, 135, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            width: 100%;
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 2px solid var(--border);
            margin-bottom: 10px;
        }

        .btn-secondary:hover {
            background: var(--bg-primary);
            border-color: var(--accent-primary);
        }

        .btn-danger {
            width: 100%;
            background: var(--accent-danger);
            color: white;
        }

        .btn-danger:hover {
            background: #e63946;
        }

        .sheet-preview-container {
            background: var(--bg-secondary);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 40px;
            overflow: auto;
        }

        .preview-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 20px;
            text-align: center;
        }

        .sheet-wrapper {
            background: white;
            width: 816px;
            height: 1056px;
            margin: 0 auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            position: relative;
            padding: 48px 18px;
        }

        .label-grid {
            display: grid;
            grid-template-columns: repeat(3, 252px);
            grid-template-rows: repeat(10, 96px);
            gap: 0;
        }

        .label-cell {
            border: 1px dashed #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 4px;
            overflow: hidden;
        }

        .label-cell:hover {
            background: rgba(0, 255, 135, 0.05);
            border-color: var(--accent-primary);
        }

        .label-cell.selected {
            background: rgba(0, 212, 255, 0.1);
            border: 2px solid var(--accent-secondary);
        }

        .label-cell.filled {
            background: rgba(0, 255, 135, 0.05);
        }

        .label-content {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .label-barcode {
            max-width: 95%;
            height: auto;
        }

        .label-description {
            font-size: 5px;
            color: #333;
            margin-top: 1px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }

        .label-number {
            position: absolute;
            top: 2px;
            left: 2px;
            font-size: 8px;
            color: #999;
            font-weight: bold;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-box {
            background: var(--bg-primary);
            border: 2px solid var(--border);
            border-radius: 8px;
            padding: 12px;
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--accent-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 4px;
        }

        .alert {
            padding: 12px 16px;
            border-radius: 8px;
            margin-bottom: 16px;
            border-left: 4px solid;
            font-size: 13px;
        }

        .alert-info {
            background: rgba(0, 212, 255, 0.1);
            border-color: var(--accent-secondary);
            color: var(--accent-secondary);
        }

        .alert-success {
            background: rgba(0, 255, 135, 0.1);
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }

        .alert-warning {
            background: rgba(255, 215, 0, 0.1);
            border-color: var(--accent-warning);
            color: var(--accent-warning);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
            cursor: pointer;
        }

        .field-preview {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 6px;
            padding: 8px;
            margin-top: 8px;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .field-preview strong {
            color: var(--accent-primary);
        }

        .spinner {
            border: 3px solid var(--border);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media print {
            body {
                background: white;
                padding: 0;
                margin: 0;
            }
            .screen-only {
                display: none !important;
            }
            .print-sheet {
                display: block !important;
            }
            @page {
                size: letter;
                margin: 0;
            }
        }

        /* Standard 3-column label sheet (Avery 5160 compatible) */
        /* 8.5" x 11" page with 30 labels (3 columns x 10 rows) */
        .print-sheet {
            display: none;
            width: 8.5in;
            height: 11in;
            padding: 0.5in 0.1875in; /* Top/bottom: 0.5", Left/right: 0.1875" */
            page-break-after: always;
        }

        .print-label-grid {
            display: grid;
            grid-template-columns: repeat(3, 2.625in); /* 3 columns, 2.625" each */
            grid-template-rows: repeat(10, 1in); /* 10 rows, 1" each */
            gap: 0;
            width: 100%;
            height: 100%;
        }

        .print-label {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0.05in;
            overflow: hidden;
            box-sizing: border-box;
        }

        .print-label svg {
            max-width: 95%;
            height: auto;
            max-height: 0.6in; /* Barcode height */
        }

        .print-label-description {
            font-size: 6pt;
            text-align: center;
            color: #000;
            margin-top: 2px;
            line-height: 1.1;
            max-height: 0.3in;
            overflow: hidden;
        }

        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            .sidebar {
                position: static;
            }
            .sheet-wrapper {
                transform: scale(0.7);
                transform-origin: top center;
            }
        }
    </style>
</head>
<body>
    <div class="background-grid"></div>
    
    <div class="app-container">
        <div class="screen-only">
            <div class="header">
                <h1>üè∑Ô∏è Integrated Label Maker</h1>
                <p>A1A OL877WX - Creates labels AND adds to inventory database</p>
            </div>

            <div id="authRequired" style="display: none; max-width: 600px; margin: 100px auto; text-align: center;">
                <div class="alert alert-info">
                    <strong>‚ö†Ô∏è Login Required</strong><br>
                    Please log in through your inventory system first, then refresh this page.
                </div>
            </div>

            <div id="mainContent" style="display: none;">
                <div class="main-content">
                    <div class="sidebar">
                        <div class="stats">
                            <div class="stat-box">
                                <div class="stat-value" id="filledCount">0</div>
                                <div class="stat-label">Filled</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="emptyCount">30</div>
                                <div class="stat-label">Empty</div>
                            </div>
                            <div class="stat-box">
                                <div class="stat-value" id="selectedCell">-</div>
                                <div class="stat-label">Selected</div>
                            </div>
                        </div>

                        <div id="selectionAlert" class="alert alert-info" style="display: none;">
                            <strong>Label #<span id="selectedNumber">1</span> selected</strong><br>
                            Fill out required fields and click "Add to Label"
                        </div>

                        <div class="card">
                            <div class="card-title">üîç Reprint Existing Item</div>
                            
                            <div class="form-group">
                                <label class="form-label">Search by Name or Serial</label>
                                <input type="text" id="existingItemSearch" class="form-input" placeholder="Start typing item name or serial..." autocomplete="off">
                                <div id="searchResults" style="display: none; position: relative; margin-top: 4px; max-height: 200px; overflow-y: auto; background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 8px;"></div>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Or Select from List</label>
                                <select id="existingItemSelect" class="form-select">
                                    <option value="">-- Select an item to reprint --</option>
                                </select>
                            </div>

                            <button type="button" class="btn btn-success" onclick="loadExistingItem()" style="width: 100%; margin-top: 12px;">
                                üì• Load Item Details
                            </button>

                            <div style="margin-top: 12px; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; font-size: 12px; color: var(--text-secondary);">
                                üí° <strong>Tip:</strong> Select an existing item to automatically fill all fields for reprinting labels
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-title">üî¢ Barcode / Serial Number</div>
                            
                            <div class="form-group">
                                <label class="form-label required">Barcode / Serial</label>
                                <input type="text" id="manualBarcode" class="form-input" placeholder="Type barcode directly: ITEM-001, ABC123, etc.">
                            </div>

                            <div style="margin: 16px 0; padding: 12px; background: var(--bg-tertiary); border-radius: 8px; border-left: 3px solid var(--accent-primary);">
                                <strong>üí° Direct Input:</strong> Type any barcode format<br>
                                <span style="font-size: 12px; color: var(--text-secondary);">
                                    Examples: ITEM-001, SKU-ABC-123, PIPE-2024-001
                                </span>
                            </div>

                            <details>
                                <summary style="cursor: pointer; padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px;">
                                    <strong>üî¢ Or Use Auto-Generate</strong>
                                </summary>
                                <div style="padding: 12px;">
                                    <div class="form-group">
                                        <label class="form-label">Prefix</label>
                                        <input type="text" id="barcodePrefix" class="form-input" value="ITEM-" placeholder="e.g., ITEM-, SKU-">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Next Number</label>
                                        <input type="number" id="nextNumber" class="form-input" value="1" min="1">
                                    </div>

                                    <div class="form-group">
                                        <label class="form-label">Padding</label>
                                        <input type="number" id="padding" class="form-input" value="3" min="0" max="10">
                                    </div>

                                    <div class="checkbox-group">
                                        <input type="checkbox" id="autoIncrement" class="checkbox" checked>
                                        <label>Auto-increment</label>
                                    </div>

                                    <button type="button" class="btn btn-secondary" onclick="useAutoBarcode()" style="width: 100%; margin-top: 8px;">
                                        ‚Üì Use Auto-Generated Barcode
                                    </button>

                                    <div class="field-preview" style="margin-top: 12px;">
                                        <strong>Next:</strong> <span id="nextBarcodePreview">ITEM-001</span>
                                    </div>
                                </div>
                            </details>
                        </div>

                        <div class="card">
                            <div class="card-title">üì¶ Required Fields</div>
                            
                            <div class="form-group">
                                <label class="form-label required">Item Name</label>
                                <input type="text" id="itemName" class="form-input" placeholder="Red Widget" list="itemNameSuggestions" autocomplete="off">
                                <datalist id="itemNameSuggestions"></datalist>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Product Description</label>
                                <textarea id="productDescription" class="form-textarea" placeholder="Detailed product description"></textarea>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Location</label>
                                <input type="text" id="location" class="form-input" placeholder="Warehouse A" list="locationSuggestions" autocomplete="off">
                                <datalist id="locationSuggestions"></datalist>
                            </div>

                            <div class="form-group">
                                <label class="form-label required">Bin Location</label>
                                <input type="text" id="binLocation" class="form-input" placeholder="Shelf 3, Bin 12" list="binLocationSuggestions" autocomplete="off">
                                <datalist id="binLocationSuggestions"></datalist>
                            </div>

                            <div class="field-preview">
                                <strong>Label will show:</strong><br>
                                <div id="labelPreviewText">Fill in fields to preview...</div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-title">‚öôÔ∏è Settings</div>
                            
                            <div class="form-group">
                                <label class="form-label">Barcode Format</label>
                                <select id="barcodeFormat" class="form-select">
                                    <option value="CODE128">CODE128 (Recommended)</option>
                                    <option value="CODE39">CODE39</option>
                                    <option value="EAN13">EAN13</option>
                                    <option value="UPC">UPC-A</option>
                                </select>
                            </div>

                            <div class="form-group">
                                <label class="form-label">Fill Mode</label>
                                <select id="fillMode" class="form-select">
                                    <option value="single">Single Label</option>
                                    <option value="fill">Fill Remaining</option>
                                </select>
                            </div>

                            <div class="checkbox-group">
                                <input type="checkbox" id="showText" class="checkbox" checked>
                                <label>Show barcode text</label>
                            </div>
                        </div>

                        <button class="btn btn-primary" id="addToLabelBtn" onclick="addToLabel()">
                            ‚ûï Add to Label & Database
                        </button>

                        <button class="btn btn-secondary" onclick="clearSelected()">
                            üóëÔ∏è Clear Selected
                        </button>

                        <button class="btn btn-secondary" onclick="clearAll()">
                            üóëÔ∏è Clear All Labels
                        </button>

                        <button class="btn btn-primary" onclick="printLabels()">
                            üñ®Ô∏è Print Labels
                        </button>

                        <button class="btn btn-secondary" onclick="window.open('/', '_blank')" style="margin-top: 20px; border-top: 2px solid var(--border); padding-top: 20px;">
                            üì¶ Back to Inventory
                        </button>

                        <button class="btn btn-secondary" onclick="handleLogout()" style="margin-top: 10px; background: var(--accent-danger); border-color: var(--accent-danger);">
                            üö™ Logout
                        </button>

                        <div class="alert alert-success" style="margin-top: 20px;">
                            <strong>‚úÖ Database Integration</strong><br>
                            Labels automatically create inventory records when printed!
                        </div>

                        <div id="statusMessage" style="margin-top: 10px;"></div>
                    </div>

                    <div class="sheet-preview-container">
                        <div class="preview-title">Label Sheet Preview</div>
                        <div style="padding: 12px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 12px; border-left: 3px solid var(--accent-secondary);">
                            <strong>üí° Tip:</strong> Drag and drop filled labels to rearrange them!
                            <div style="font-size: 12px; color: var(--text-secondary); margin-top: 4px;">
                                Click a filled label and drag it to another position to swap
                            </div>
                        </div>
                        <div class="sheet-wrapper">
                            <div class="label-grid" id="labelGrid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="printArea"></div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBS-a3pzozzUEBeFlVQzPs4cD6uNDPzN2c",
            authDomain: "midstateinventory-43f99.firebaseapp.com",
            projectId: "midstateinventory-43f99",
            storageBucket: "midstateinventory-43f99.firebasestorage.app",
            messagingSenderId: "20000371750",
            appId: "1:20000371750:web:e255b4b72661c27c2b62e7",
            measurementId: "G-814FR7GR7T"
        };

        let app, auth, db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            auth = firebase.auth();
            db = firebase.firestore();
        } catch (error) {
            console.error("Firebase initialization error:", error);
        }

        // State
        let labels = Array(30).fill(null);
        let selectedCell = null;
        let currentUser = null;
        let inventoryItems = []; // Store inventory for autocomplete

        // Fetch inventory items
        async function fetchInventory() {
            try {
                const snapshot = await db.collection('inventory').get();
                inventoryItems = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                console.log(`Loaded ${inventoryItems.length} inventory items`);
                setupAutocomplete();
                populateItemSelect();
            } catch (error) {
                console.error('Error fetching inventory:', error);
            }
        }

        // Setup autocomplete for search
        function setupAutocomplete() {
            const searchInput = document.getElementById('existingItemSearch');
            const resultsDiv = document.getElementById('searchResults');

            searchInput.addEventListener('input', (e) => {
                const query = e.target.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                const matches = inventoryItems.filter(item => 
                    (item.name && item.name.toLowerCase().includes(query)) ||
                    (item.serial && item.serial.toLowerCase().includes(query)) ||
                    (item.brand && item.brand.toLowerCase().includes(query))
                ).slice(0, 10);

                if (matches.length === 0) {
                    resultsDiv.style.display = 'none';
                    return;
                }

                resultsDiv.innerHTML = matches.map(item => `
                    <div onclick="selectSearchItem('${item.id}')" style="padding: 12px; cursor: pointer; border-bottom: 1px solid var(--border); transition: background 0.2s;" onmouseover="this.style.background='var(--bg-tertiary)'" onmouseout="this.style.background='transparent'">
                        <div style="font-weight: 600; color: var(--accent-primary);">${item.name || 'Unnamed'}</div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            ${item.brand ? item.brand + ' ‚Ä¢ ' : ''}${item.serial || 'No serial'} ‚Ä¢ ${item.location || 'No location'}
                        </div>
                    </div>
                `).join('');

                resultsDiv.style.display = 'block';
            });

            // Close dropdown when clicking outside
            document.addEventListener('click', (e) => {
                if (!searchInput.contains(e.target) && !resultsDiv.contains(e.target)) {
                    resultsDiv.style.display = 'none';
                }
            });

            // Populate datalists for field autocomplete
            populateDataLists();
        }

        // Populate datalists with unique values from inventory
        function populateDataLists() {
            // Item names
            const itemNames = [...new Set(inventoryItems.map(i => i.name).filter(Boolean))].sort();
            const itemNameList = document.getElementById('itemNameSuggestions');
            itemNameList.innerHTML = itemNames.map(name => `<option value="${name}">`).join('');

            // Locations
            const locations = [...new Set(inventoryItems.map(i => i.location).filter(Boolean))].sort();
            const locationList = document.getElementById('locationSuggestions');
            locationList.innerHTML = locations.map(loc => `<option value="${loc}">`).join('');

            // Bin Locations
            const binLocations = [...new Set(inventoryItems.map(i => i.binLocation).filter(Boolean))].sort();
            const binLocationList = document.getElementById('binLocationSuggestions');
            binLocationList.innerHTML = binLocations.map(bin => `<option value="${bin}">`).join('');
        }

        // Populate dropdown select
        function populateItemSelect() {
            const select = document.getElementById('existingItemSelect');
            select.innerHTML = '<option value="">-- Select an item to reprint --</option>';
            
            inventoryItems
                .sort((a, b) => (a.name || '').localeCompare(b.name || ''))
                .forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.id;
                    option.textContent = `${item.name || 'Unnamed'} (${item.serial || 'No serial'})`;
                    select.appendChild(option);
                });
        }

        // Select item from search results
        function selectSearchItem(itemId) {
            document.getElementById('existingItemSelect').value = itemId;
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('existingItemSearch').value = '';
            loadExistingItem();
        }

        // Load existing item into form
        function loadExistingItem() {
            const itemId = document.getElementById('existingItemSelect').value;
            
            if (!itemId) {
                alert('Please select an item first');
                return;
            }

            const item = inventoryItems.find(i => i.id === itemId);
            
            if (!item) {
                alert('Item not found');
                return;
            }

            // Fill form fields
            document.getElementById('manualBarcode').value = item.serial || '';
            document.getElementById('itemName').value = item.name || '';
            document.getElementById('productDescription').value = item.productDescription || item.brand || '';
            document.getElementById('location').value = item.location || '';
            document.getElementById('binLocation').value = item.binLocation || '';
            
            // Update preview
            updateNextBarcodePreview();
            updateLabelPreview();

            // Show success message
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="alert alert-success">‚úì Loaded: ${item.name} - Ready to add to label</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 3000);
        }

        // Logout function
        async function handleLogout() {
            if (confirm('Are you sure you want to logout?')) {
                try {
                    await auth.signOut();
                    currentUser = null;
                    window.location.reload();
                } catch (error) {
                    console.error('Logout error:', error);
                    alert('Error logging out. Please try again.');
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            auth.onAuthStateChanged((user) => {
                currentUser = user;
                if (user) {
                    document.getElementById('authRequired').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    renderGrid();
                    updateStats();
                    updateNextBarcodePreview();
                    fetchInventory(); // Load inventory for autocomplete
                } else {
                    document.getElementById('authRequired').style.display = 'block';
                    document.getElementById('mainContent').style.display = 'none';
                }
            });

            ['barcodePrefix', 'nextNumber', 'padding'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateNextBarcodePreview);
            });

            ['itemName', 'productDescription', 'location', 'binLocation'].forEach(id => {
                document.getElementById(id)?.addEventListener('input', updateLabelPreview);
            });
        });

        function updateNextBarcodePreview() {
            const prefix = document.getElementById('barcodePrefix').value;
            const nextNum = parseInt(document.getElementById('nextNumber').value) || 1;
            const padding = parseInt(document.getElementById('padding').value) || 4;
            
            const barcode = generateBarcode(prefix, nextNum, padding);
            document.getElementById('nextBarcodePreview').textContent = barcode;
        }

        function updateLabelPreview() {
            const name = document.getElementById('itemName').value;
            const location = document.getElementById('location').value;
            const binLocation = document.getElementById('binLocation').value;

            let preview = '';
            if (name) preview += `<strong>${name}</strong><br>`;
            if (location && binLocation) {
                preview += `${location} - ${binLocation}`;
            } else if (location) {
                preview += location;
            } else if (binLocation) {
                preview += binLocation;
            }

            document.getElementById('labelPreviewText').innerHTML = preview || 'Fill in fields to preview...';
        }

        function generateBarcode(prefix, number, padding) {
            const paddedNumber = String(number).padStart(padding, '0');
            return prefix + paddedNumber;
        }

        function getNextBarcode() {
            const prefix = document.getElementById('barcodePrefix').value;
            const nextNum = parseInt(document.getElementById('nextNumber').value);
            const padding = parseInt(document.getElementById('padding').value);
            return generateBarcode(prefix, nextNum, padding);
        }

        function useAutoBarcode() {
            const autoBarcode = getNextBarcode();
            document.getElementById('manualBarcode').value = autoBarcode;
        }

        function incrementBarcode() {
            const autoIncrement = document.getElementById('autoIncrement').checked;
            if (autoIncrement) {
                const nextNumInput = document.getElementById('nextNumber');
                const currentNum = parseInt(nextNumInput.value) || 1;
                nextNumInput.value = currentNum + 1;
                updateNextBarcodePreview();
            }
        }

        function renderGrid() {
            const grid = document.getElementById('labelGrid');
            grid.innerHTML = '';

            for (let i = 0; i < 30; i++) {
                const cell = document.createElement('div');
                cell.className = `label-cell ${selectedCell === i ? 'selected' : ''} ${labels[i] ? 'filled' : ''}`;
                cell.onclick = () => selectCell(i);
                
                // Make label draggable if it has content
                if (labels[i]) {
                    cell.draggable = true;
                    cell.style.cursor = 'grab';
                    
                    cell.ondragstart = (e) => {
                        e.dataTransfer.effectAllowed = 'move';
                        e.dataTransfer.setData('text/plain', i);
                        cell.style.opacity = '0.5';
                        cell.style.cursor = 'grabbing';
                    };
                    
                    cell.ondragend = (e) => {
                        cell.style.opacity = '1';
                        cell.style.cursor = 'grab';
                    };
                }
                
                // Allow drop on all cells
                cell.ondragover = (e) => {
                    e.preventDefault();
                    cell.style.background = 'rgba(0, 255, 135, 0.1)';
                };
                
                cell.ondragleave = (e) => {
                    cell.style.background = '';
                };
                
                cell.ondrop = (e) => {
                    e.preventDefault();
                    cell.style.background = '';
                    
                    const fromIndex = parseInt(e.dataTransfer.getData('text/plain'));
                    const toIndex = i;
                    
                    if (fromIndex !== toIndex) {
                        // Swap labels
                        const temp = labels[fromIndex];
                        labels[fromIndex] = labels[toIndex];
                        labels[toIndex] = temp;
                        renderGrid();
                        updateStats();
                        showStatus(`‚úì Label moved from position ${fromIndex + 1} to ${toIndex + 1}`);
                    }
                };

                const number = document.createElement('div');
                number.className = 'label-number';
                number.textContent = i + 1;
                cell.appendChild(number);

                if (labels[i]) {
                    const content = document.createElement('div');
                    content.className = 'label-content';

                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.className = 'label-barcode';
                    svg.id = `preview-barcode-${i}`;
                    content.appendChild(svg);

                    if (labels[i].labelDescription) {
                        const desc = document.createElement('div');
                        desc.className = 'label-description';
                        desc.textContent = labels[i].labelDescription;
                        content.appendChild(desc);
                    }

                    cell.appendChild(content);

                    setTimeout(() => {
                        try {
                            JsBarcode(`#preview-barcode-${i}`, labels[i].barcode, {
                                format: labels[i].format,
                                width: 1.5,
                                height: 30,
                                displayValue: labels[i].showText,
                                fontSize: 8,
                                margin: 1
                            });
                        } catch (error) {
                            console.error('Barcode error:', error);
                        }
                    }, 50);
                }

                grid.appendChild(cell);
            }
        }

        function selectCell(index) {
            selectedCell = index;
            renderGrid();
            updateStats();
            
            document.getElementById('selectionAlert').style.display = 'block';
            document.getElementById('selectedNumber').textContent = index + 1;
        }

        function updateStats() {
            const filled = labels.filter(l => l !== null).length;
            document.getElementById('filledCount').textContent = filled;
            document.getElementById('emptyCount').textContent = 30 - filled;
            document.getElementById('selectedCell').textContent = selectedCell !== null ? selectedCell + 1 : '-';
        }

        function showStatus(message, isError = false) {
            const statusDiv = document.getElementById('statusMessage');
            statusDiv.innerHTML = `<div class="alert ${isError ? 'alert-warning' : 'alert-success'}">${message}</div>`;
            setTimeout(() => {
                statusDiv.innerHTML = '';
            }, 5000);
        }

        async function addToLabel() {
            if (selectedCell === null) {
                alert('Please select a label cell first');
                return;
            }

            if (!currentUser) {
                alert('Please log in first');
                return;
            }

            const manualBarcode = document.getElementById('manualBarcode').value.trim();
            const itemName = document.getElementById('itemName').value.trim();
            const productDescription = document.getElementById('productDescription').value.trim();
            const location = document.getElementById('location').value.trim();
            const binLocation = document.getElementById('binLocation').value.trim();

            if (!manualBarcode) {
                alert('Please enter a barcode/serial number');
                return;
            }

            if (!itemName || !productDescription || !location || !binLocation) {
                alert('Please fill in all required fields (Item Name, Product Description, Location, Bin Location)');
                return;
            }

            const format = document.getElementById('barcodeFormat').value;
            const showText = document.getElementById('showText').checked;
            const fillMode = document.getElementById('fillMode').value;

            // Label description for printing
            const labelDescription = `${location} - ${binLocation}`;

            const labelData = {
                barcode: manualBarcode,
                itemName: itemName,
                productDescription: productDescription,
                location: location,
                binLocation: binLocation,
                labelDescription: labelDescription,
                format: format,
                showText: showText,
                createdAt: new Date().toISOString(),
                createdBy: currentUser.displayName || currentUser.email
            };

            if (fillMode === 'fill') {
                // Fill from selected to end with same barcode
                for (let i = selectedCell; i < 30; i++) {
                    labels[i] = {
                        ...labelData
                    };
                }
            } else {
                labels[selectedCell] = labelData;
                
                if (selectedCell < 29) {
                    selectedCell++;
                }
            }

            // Auto-increment the manual barcode if it matches auto-gen pattern
            const autoIncrement = document.getElementById('autoIncrement').checked;
            if (autoIncrement) {
                // Try to increment if barcode ends with numbers
                const match = manualBarcode.match(/^(.*?)(\d+)$/);
                if (match) {
                    const prefix = match[1];
                    const number = parseInt(match[2]);
                    const padding = match[2].length;
                    const nextBarcode = prefix + String(number + 1).padStart(padding, '0');
                    document.getElementById('manualBarcode').value = nextBarcode;
                }
            }

            renderGrid();
            updateStats();
            updateLabelPreview();
            
            showStatus('‚úì Label added! Will be saved to database when you print.');
        }

        async function saveLabelToDatabase(labelData) {
            try {
                // Check if item with this serial number already exists
                const existingItemQuery = await db.collection('inventory')
                    .where('serial', '==', labelData.barcode)
                    .get();

                if (!existingItemQuery.empty) {
                    // Item already exists - skip it
                    console.log(`Item with serial ${labelData.barcode} already exists, skipping...`);
                    return { exists: true, serial: labelData.barcode };
                }

                // Create inventory entry (but quantity stays 0 until stocked)
                const inventoryData = {
                    serial: labelData.barcode,
                    name: labelData.itemName,
                    brand: '', // Will be filled when stocked
                    model: '', // Will be filled when stocked
                    style: '',
                    size: '',
                    department: '',
                    location: labelData.location,
                    binLocation: labelData.binLocation || '',
                    secondaryLocation: '',
                    productDescription: labelData.productDescription || '',
                    quantity: 0, // IMPORTANT: Stays 0 until item is stocked
                    price: 0, // Will be filled when stocked
                    reorderPoint: 10,
                    hasMissingParts: false,
                    missingPartsNotes: '',
                    photoURL: '',
                    locationPhotoURL: '',
                    pickedBy: currentUser.displayName || currentUser.email,
                    pickedByUid: currentUser.uid,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    scannerType: 'label-maker',
                    mode: 'label-created',
                    needsStocking: true // Flag to indicate this needs to be stocked
                };

                await db.collection('inventory').add(inventoryData);
                console.log(`Inventory entry created for ${labelData.itemName} - Needs stocking to set quantity`);
                return { exists: false, serial: labelData.barcode };
            } catch (error) {
                console.error('Error saving to database:', error);
                return { error: true, message: error.message };
            }
        }

        function clearSelected() {
            if (selectedCell === null) return;
            labels[selectedCell] = null;
            renderGrid();
            updateStats();
        }

        function clearAll() {
            if (confirm('Clear all labels?')) {
                labels = Array(30).fill(null);
                selectedCell = null;
                renderGrid();
                updateStats();
                document.getElementById('selectionAlert').style.display = 'none';
            }
        }

        async function printLabels() {
            const filledLabels = labels.filter(l => l !== null);
            if (filledLabels.length === 0) {
                alert('Please add at least one label');
                return;
            }

            const btn = document.getElementById('addToLabelBtn');
            btn.disabled = true;
            btn.textContent = 'Saving to database...';

            // Save all labels to database
            let successCount = 0;
            let duplicateCount = 0;
            let errorCount = 0;
            const duplicates = [];

            for (const label of filledLabels) {
                const result = await saveLabelToDatabase(label);
                if (result.exists) {
                    duplicateCount++;
                    duplicates.push(result.serial);
                } else if (result.error) {
                    errorCount++;
                } else {
                    successCount++;
                }
            }

            btn.disabled = false;
            btn.textContent = '‚ûï Add to Label & Database';

            let message = '';
            if (successCount > 0) {
                message += `‚úì ${successCount} new item(s) saved. `;
            }
            if (duplicateCount > 0) {
                message += `‚ö† ${duplicateCount} duplicate(s) skipped (already exist): ${duplicates.join(', ')}. `;
            }
            if (errorCount > 0) {
                message += `‚ùå ${errorCount} failed. `;
            }

            showStatus(message, errorCount > 0);

            // Generate print layout
            generatePrintSheet();
            
            setTimeout(() => {
                window.print();
            }, 500);
        }

        function generatePrintSheet() {
            const printArea = document.getElementById('printArea');
            printArea.innerHTML = '';

            const sheet = document.createElement('div');
            sheet.className = 'print-sheet';

            const grid = document.createElement('div');
            grid.className = 'print-label-grid';

            labels.forEach((label, index) => {
                const labelDiv = document.createElement('div');
                labelDiv.className = 'print-label';

                if (label) {
                    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    svg.id = `print-barcode-${index}`;
                    labelDiv.appendChild(svg);

                    if (label.labelDescription) {
                        const desc = document.createElement('div');
                        desc.className = 'print-label-description';
                        desc.textContent = label.labelDescription;
                        labelDiv.appendChild(desc);
                    }

                    setTimeout(() => {
                        try {
                            JsBarcode(`#print-barcode-${index}`, label.barcode, {
                                format: label.format,
                                width: 2,
                                height: 40,
                                displayValue: label.showText,
                                fontSize: 10,
                                margin: 2
                            });
                        } catch (error) {
                            console.error('Barcode generation error:', error);
                        }
                    }, 100);
                }

                grid.appendChild(labelDiv);
            });

            sheet.appendChild(grid);
            printArea.appendChild(sheet);
        }
    </script>
</body>
</html>
